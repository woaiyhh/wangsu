<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>极简网速测试</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- 欧式极简风 / 视觉放大 START --- */
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #eef1f4; /* 极简的浅灰背景 */
            color: #2c3e50; /* 深色文字 */
            position: relative;
            overflow: hidden;
        }

        .container {
            background-color: #ffffff; 
            border-radius: 20px; /* 更圆润的边角 */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.05); /* 柔和的阴影 */
            padding: 50px 70px; /* 增加内边距，更宽敞 */
            width: 550px; /* 增加宽度，营造大气感 */
            text-align: center;
            transition: all 0.4s ease;
            position: relative;
            z-index: 10;
        }

        h1 {
            font-size: 2.5em; /* 标题放大 */
            font-weight: 600; 
            color: #2c3e50; 
            margin-bottom: 40px;
            letter-spacing: 0.8px;
        }

        .data-row {
            margin-bottom: 35px; /* 增加行间距 */
            padding: 15px 0;
            border-bottom: 1px solid #f0f3f7; /* 更细更浅的分隔线 */
        }
        .data-row:last-of-type {
            border-bottom: none;
        }

        .label {
            font-size: 1.0em; /* 标签字体放大 */
            opacity: 0.8;
            color: #555;
            display: block;
            margin-bottom: 15px; /* 增加与数值的间距 */
            font-weight: 400;
        }

        .speed-value {
            font-size: 5.5em; /* 主速度值大幅放大，视觉冲击力强 */
            font-weight: 800; /* 更粗的字体 */
            line-height: 1.1;
            color: #007bff; /* 保持一个清晰的蓝色 */
            display: inline-block; 
            vertical-align: baseline;
            letter-spacing: -2px; /* 稍微收紧字距，更紧凑有力 */
        }

        .unit {
            font-size: 0.7em; 
            font-weight: 600;
            vertical-align: super; 
            margin-left: 8px;
            opacity: 0.7;
            color: #666;
        }

        /* 历史最高峰值使用不同颜色和字体大小强调 */
        #absoluteMaxSpeedValue {
            color: #ff8c00; /* 现代的橙色 */
            font-size: 4.0em; /* 峰值比实时值小一点，但仍保持大气 */
            font-weight: 700;
            letter-spacing: -1px;
        }

        .control-area {
            margin-top: 40px;
        }

        .control-btn {
            padding: 16px 45px; /* 按钮更宽大 */
            font-size: 1.1em;
            border: none;
            border-radius: 10px; /* 更圆润的按钮 */
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px;
            min-width: 180px; /* 按钮最小宽度增加 */
            box-shadow: none; /* 移除阴影，更扁平 */
        }

        #btn_speed {
            background-color: #007bff; 
            color: #ffffff;
        }

        #btn_speed:hover:not(:disabled) {
            background-color: #0056b3; 
        }
        
        #stopBtn {
            background-color: #e9ecef; 
            color: #495057;
        }
        
        #stopBtn:hover:not(:disabled) {
            background-color: #dae0e5; 
            color: #212529;
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #statusMessage {
            margin-top: 35px;
            font-size: 1.0em; /* 状态信息放大 */
            min-height: 20px;
            color: #6c757d; 
            line-height: 1.4;
            font-weight: 500;
        }
        
        /* 移除背景点，实现极简 */
        .background-dots {
            display: none; 
        }

        /* 隐藏原始页面的微小数据显示区域 */
        #result_down, #result_up, #result_downs, #result_ups, #delay_time, #shake_num, #lost_num {
            display: none; 
        }
        /* --- 欧式极简风 / 视觉放大 END --- */

    </style>
</head>
<body>
    <div class="background-dots"></div> 
    <div class="container">
        <h1>网络速度测试</h1>

        <div class="data-row">
            <span class="label">实时瞬时下载速度</span>
            <span id="currentSpeed" class="speed-value">0.00</span>
            <span class="unit">Mbps</span>
        </div>

        <div class="data-row">
            <span class="label">本次测试最高峰值</span>
            <span id="absoluteMaxSpeedValue" class="speed-value">0.00</span>
            <span class="unit">Mbps</span>
        </div>

        <div class="control-area">
            <input type="button" id="btn_speed" class="control-btn" value="开始持续测速" onclick="startnet(3)">
            <button id="stopBtn" class="control-btn" onclick="stopnet()" disabled>停止</button>
        </div>

        <p id="delay_time"></p><p id="shake_num"></p><p id="lost_num"></p>
        <p id="result_down" class="sults"></p><p id="result_up" class="sults"></p>
        <p id="result_downs"></p><p id="result_ups"></p>

        <p id="statusMessage">点击“开始持续测速”进行 Cloudflare 10GB 大文件平滑瞬时测试。</p>
    </div>

    <script>
        // JavaScript 核心逻辑保持不变，确保测速功能稳定
        
        // *** 核心配置：Cloudflare 10GB + 更多线程 ***
        const BASE_URL = "https://speed.cloudflare.com/__down?bytes=10737418240"; // 10 GB
        const NUM_CONNECTIONS = 15; // 增加并发线程数到 15，更激进地利用带宽
        const UPDATE_INTERVAL_MS = 500; // 每 500 毫秒计算一次瞬时速度

        // 状态变量
        let absoluteMaxSpeed = 0;   
        let isTesting = false;      
        let xhrArray = []; 
        let connectionLoadedBytes = new Array(NUM_CONNECTIONS).fill(0);

        // 用于计算瞬时速度的历史数据点
        let lastUpdateTime = 0;
        let lastTotalLoaded = 0;
        let updateIntervalId = null; 

        function updateStatus(message, color = '#6c757d') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.style.color = color;
        }
        
        // 核心函数：计算瞬时速度并平滑显示
        function updateSpeedDisplay() {
            if (!isTesting) return;

            const currentTime = new Date().getTime();
            
            // 首次启动时，跳过瞬时速度计算，只更新历史数据点
            if (lastUpdateTime === 0) {
                 lastUpdateTime = currentTime;
                 lastTotalLoaded = connectionLoadedBytes.reduce((sum, bytes) => sum + bytes, 0); 
                 return;
            }

            // 计算自上次更新以来下载了多少数据，以及经过了多少时间
            const currentTotalLoaded = connectionLoadedBytes.reduce((sum, bytes) => sum + bytes, 0); 
            const deltaLoaded = currentTotalLoaded - lastTotalLoaded;
            const deltaTime = currentTime - lastUpdateTime;

            if (deltaTime > 0) {
                // 计算瞬时速度 (Mbps)
                // (增量字节 / 增量耗时 ms) * 8 (位/字节) * 1000 (ms/s) / 1048576 (字节/Mb)
                const currentSpeedMbps = (deltaLoaded / deltaTime) * 8 * 1000 / 1048576; 
                
                // 仅在瞬时速度大于 0.05 Mbps 时才更新显示（消除连接建立时的 0 抖动）
                if (currentSpeedMbps > 0.05) {
                    document.getElementById('currentSpeed').textContent = currentSpeedMbps.toFixed(2);
                }
                
                // 更新历史最高速度 (即便速度低于 0.05Mbps，只要它高于历史最高，也应更新)
                if (currentSpeedMbps > absoluteMaxSpeed) {
                    absoluteMaxSpeed = currentSpeedMbps;
                    document.getElementById('absoluteMaxSpeedValue').textContent = absoluteMaxSpeed.toFixed(2);
                }

                // 更新历史数据点
                lastTotalLoaded = currentTotalLoaded;
                lastUpdateTime = currentTime;
            }

            // 更新状态信息
            const totalMB = (currentTotalLoaded / 1048576).toFixed(2);
            updateStatus(`正在持续测速 (已下载总计: ${totalMB} MB)`, 'rgb(0, 123, 255)');
        }

        // 核心测速启动函数
        function startnet(nodeId) {
            if (isTesting) return;
            
            // 按钮和状态设置
            document.getElementById('btn_speed').disabled = true;
            document.getElementById('btn_speed').value = `正在连接...`;
            document.getElementById('stopBtn').disabled = false;
            
            // 重置状态
            absoluteMaxSpeed = 0;
            lastTotalLoaded = 0;
            lastUpdateTime = 0; 
            connectionLoadedBytes.fill(0);
            document.getElementById('currentSpeed').textContent = '0.00';
            document.getElementById('absoluteMaxSpeedValue').textContent = '0.00';
            updateStatus(`正在建立 ${NUM_CONNECTIONS} 个连接...`, 'rgb(255, 140, 0)'); // 使用橙色

            // 清空旧的连接并准备新连接
            if (xhrArray.length > 0) {
                xhrArray.forEach(xhr => xhr.abort());
            }
            xhrArray = []; 
            
            isTesting = true; // 开启测试状态
            
            for (let i = 0; i < NUM_CONNECTIONS; i++) {
                const xhr = new XMLHttpRequest();
                xhrArray.push(xhr);

                // 每个连接使用一个随机参数
                const uniqueUrl = BASE_URL + `&conn=${i}&r=${Date.now()}`;
                
                xhr.open('GET', uniqueUrl, true);
                
                // 监听进度事件：这是唯一的下载量更新来源
                xhr.onprogress = function(event) {
                    if (!isTesting) return; 
                    connectionLoadedBytes[i] = event.loaded;
                };

                // 监听加载完成/错误/超时事件
                xhr.onload = function() {
                    if (!isTesting) return; 
                    if (xhr.status === 200) {
                        // 10GB 文件下载完成，测试自然结束
                        finishTest(true); 
                    } else {
                        updateStatus(`连接 ${i} 失败！错误码: ${xhr.status}。测试已终止。`, 'red');
                        stopnet(false); 
                    }
                };
                
                xhr.onerror = xhr.ontimeout = function() {
                    if (!isTesting) return; 
                    updateStatus(`连接 ${i} 失败或超时。测试已终止。`, 'red');
                    stopnet(false);
                };
                
                xhr.send();
            }

            // 启动平滑速度显示循环
            updateIntervalId = setInterval(updateSpeedDisplay, UPDATE_INTERVAL_MS);
        }

        // 结束测试 (自动完成或手动停止)
        function finishTest(isAuto = false) {
            // 清除平滑更新的定时器
            clearInterval(updateIntervalId);
            
            // 停止所有连接
            xhrArray.forEach(xhr => xhr.abort());
            
            // 确保测试状态关闭
            isTesting = false; 

            // 将最终结果显示在实时速度和历史最高上
            document.getElementById('currentSpeed').textContent = absoluteMaxSpeed.toFixed(2);
            document.getElementById('absoluteMaxSpeedValue').textContent = absoluteMaxSpeed.toFixed(2);
            
            if (isAuto) {
                updateStatus(`10GB 文件下载完成！最终最高速度: ${absoluteMaxSpeed.toFixed(2)} Mbps`, 'green');
            } else {
                updateStatus(`已手动停止持续测速！最终最高速度: ${absoluteMaxSpeed.toFixed(2)} Mbps`, '#ff8c00'); // 手动停止用橙色
            }
            
            // 重置控制按钮状态
            resetControls();
        }

        // 手动停止测试
        function stopnet(isManual = true) {
             // 如果 isTesting 已经为 false，且不是手动停止（即前面已经因错误或完成而停止了），则不执行任何操作
            if (!isTesting && !isManual) return;
            
            finishTest(false);
        }
        
        function resetControls() {
            document.getElementById('btn_speed').disabled = false;
            document.getElementById('btn_speed').value = '开始持续测速';
            document.getElementById('stopBtn').disabled = true;
        }

        // 确保页面加载完成后，按钮状态是正确的
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('stopBtn').disabled = true;
        });

    </script>
</body>
</html>